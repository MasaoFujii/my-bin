name: linux-base
on:
  push:
    branches:
      - "*"
jobs:
  linux-base:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    env:
      PG_TEST_EXTRA: "ssl kerberos"
    steps:
    - uses: actions/checkout@v2
    - name: apt
      run: |
        sudo apt-get --yes update
        sudo apt-get --yes install gcc libreadline-dev flex bison make perl libipc-run-perl clang llvm-dev libperl-dev libpython-dev tcl-dev libldap2-dev libicu-dev docbook-xml docbook-xsl fop libxml2-utils xsltproc krb5-admin-server krb5-kdc krb5-user slapd ldap-utils libssl-dev pkg-config locales-all gdb
    - name: configure
      run: |
        ./configure --prefix=$HOME/install --enable-debug --enable-cassert --enable-tap-tests -with-tcl --with-python --with-perl --with-ldap --with-openssl --with-icu --with-llvm
    - name: make
      run: |
        echo "COPT=-Wall -Werror" > src/Makefile.custom
        export CPPFLAGS="-DENFORCE_REGRESSION_TEST_NAME_RESTRICTIONS $CPPFLAGS"
        make -s -j 4 all contrib docs
    - name: make install
      run: |
        make -s install
    - name: make check-world
      run: |
        make -s -j 4 check-world
    - name: after failure
      if: failure()
      run: |
        for f in $(find . -name regression.diffs) ; do echo "========= Contents of $f" ; head -1000 $f ; done
        for f in $(find . -name install.log) ; do echo "========= Contents of $f" ; tail -100 $f ; done
